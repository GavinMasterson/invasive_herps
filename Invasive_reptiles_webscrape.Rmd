---
title: "Invasive Herpetofauna"
author: "Gavin Masterson"
date: "29/11/2019"
output: html_document
---

```{r global options, include = TRUE}
knitr::opts_chunk$set(echo = TRUE)
```

# Invasive Herpetofauna

How many species of alien invasive herpetofauna are there globally? What are they? Where are they from? Where are they invasive? Keeping up to date with global trends and situations in herpetofaunal conservation is an ongoing challenge. Some of the most infamous invasive species are reptiles - think of the Burmese Python (*Python bivittatus*) in Florida, or the Brown Tree Snake (*Boiga irregularis*) in Guam - and amphibians - think of the Cane Toad (*Rhinella marina*) in Australia or the Common Platanna (*Xenopus laevis*) in Europe. As a herpetologist, I wanted to develop a reproducible webscraping method that will allow me to keep up to date on alien/invasive herpetofaunal species. 

[The Global Invasive Species Database](http://www.iucngisd.org/gisd/) (GISD) is a product of the work of the IUCN's Species Survival Commission. Initial development of the GISD took place between 1998 and 2000, and the database received a functionality/cosmetic upgrade in 2004. The GISD database is an ongoing project and is curated by the work of specialists who volunteer their valuable time and expertise. More information can be found [here](http://www.iucngisd.org/gisd/about.php) on the GISD website.

For the work presented below, I was inspired by [this tutorial](https://naturaldatasolutions.com/2018/11/28/scraping-and-visualizing-the-gisd-with-r/) by Jim Sheehan on November 28, 2018. Jim's work inspired me to do this, my first webscraping project, and I relied on his post for navigating the mechanics of the coding. I am grateful to him for his post.

## Setting up 

As always the first thing to do is to load the list of packages required for the project. This list usually gets built over time as you go through the project and then ends up complete by the end of the work.

```{r setup}
library(robotstxt)    # check website scraping rules
library(tidyverse)    # simultaneously load the stringr, dplyr, ggplot2 and readr packages
library(rvest)        # web scraping
library(knitr)        # HTML table creation
library(kableExtra)   # additional HTML table formatting
library(plotly)       # interactive plots
library(gganimate)    # animate ggplots
library(rworldmap)    # world chloropleth mapping
```

## Webscraping Invasive Herpetofauna from the GISD

The code below imports the saved .csv file from my Advanced Search on the GISD.I limited my search to Reptiles and Amphibians and saved the search return as a .csv file named "amrep_gisd.csv". After importing the data I noticed that there were two issues. Several entries in the "Order" column are currently missing from the database. The second issue is that the importing process adds an additional column of NA values, which needs to be removed. The last two lines of code in the chunk below fill in the missing values for the "Order" column and also remove the "X" column.

```{r import}

# IDEALLY THIS COULD BE MODIFIED TO ALLOW ME TO OBTAIN THE ADVANCED SEARCH RESULTS AUTOMATICALLY, WHERE I APPEND THE DATE AND TIME OF THE SEARCH SO THAT IT IS SAVED IN THE FILE METADATA AND CAN BE USED TO COMPARE THE RESULTS YEAR ON YEAR ETC.

sp_list <- read_csv2("amrep_gisd.csv", trim_ws = TRUE) #Not sure why it adds the 8th column with NA values

kable(sp_list[1:10,]) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

sp_list[2:15,5] <- "Squamata"
sp_list <- sp_list[,-8]
              
```

Herpetofaunal taxonomy  because of the historical use of subspecies.  This means that we need to allow for the possibility of species whose names contain a *generic name*, *specific name* and a *subspecific name* in the "Species" column of our dataset. For example, the Red-eared Slider is a widespread invasive that is known by the Latin name of *Trachemys scripta elegans*, where the subspecific name is "elegans". The problem here is that whenever a species has no *subspecific name*, the code below will add "+NA" to the end of the URL rendering it useless for accessing the species page.

```{r URLs}

sp_list <- sp_list %>% 
  tidyr::separate(Species, c("genus", "species", "subspecies"), sep = " ", remove = FALSE) %>% 
  tidyr::unite(c(genus, species, subspecies), col = "genspp", sep = "+", remove = FALSE) %>% 
  mutate(url = paste0("http://www.iucngisd.org/gisd/speciesname/", genspp)) %>% 
  select(-genspp)

sp_list[sample(nrow(sp_list),5),]$url  # display a random sample of 5 URLs
```

To fix the URLs we need to snip the ends of the URLS that end in exactly "+NA". The code below has the additional step for removing "+NA" from the URLs of species that do not have a subspecific name. (Note: if you are using R in a language other than English, you should refer to documentation for the 'locale'argument of the 'coll()' function in stringr.)

```{r fixed URLs}

sp_list$url <- str_replace(sp_list$url, pattern = coll(pattern = "+NA"), replacement = "")

sp_list[c(1,15,17, 19, 40),]$url  # display a random sample of 5 URLs
```

The URLs are now correctly specified and we can now scrape each of the species reports. As metnioned above, I'm interested in keeping up-to-date with the total number of invasive herpetofauna, where they're invasive and where they're from. The total number can already be deduced from the length of the sp_list object. Now we need to scrape the lists of countries where each species is native and where they have established. Below I use the same approach that Jim Sheehan used in the post I linked above. It involves looping across each URL in the sp_list object and selecting the correct HTML object to populate the two, pre-specified lists that are created to receive the scraped information. I have modified the object names, have not used 'tryCatch' and I have directly assigned each scrape into the relevant list.

```{r scrape}
urls <- pull(sp_list, url)
sp_names <- pull(sp_list, Species)
a_range <- vector(mode = "list", length = length(urls))
n_range <- vector(mode = "list", length = length(urls))

names(a_range) <- sp_names; names(n_range) <- sp_names

# Scrape each URL with a 5-second delay in between each iteration

for(i in 1:length(urls)){
    a_range[[i]] <-  read_html(urls[i]) %>% 
                html_nodes(xpath = '//*[@id="l-1st-step"]') %>% 
                html_nodes("li") %>% 
                html_text()
    
    n_range[[i]] <-  read_html(urls[i]) %>% 
                html_nodes(xpath = '//*[@id="nr-col"]') %>% 
                html_nodes("li") %>% 
                html_text()
    
    Sys.sleep(5)
}
rm(i)
```

```{r tibble building}

# Countries where the species is indigenous
n_range_df <- data.frame(Species = rep(names(n_range), sapply(n_range, length)),
                 Native_range = unlist(n_range), row.names = NULL, stringsAsFactors = FALSE)
n_range_tbl <- inner_join(sp_list[,],n_range_df, by = "Species") %>% 
              as_tibble()

# Countries where the species has established an alien or invasive population
a_range_df <- data.frame(Species = rep(names(a_range), sapply(a_range, length)),
                 Alien_range = unlist(a_range), row.names = NULL, stringsAsFactors = FALSE)
a_range_df$Alien_range <- gsub("[[:digit:]]|\\[|\\]","", a_range_df$Alien_range)
a_range_tbl <- inner_join(sp_list[,], a_range_df, by = "Species") %>% 
              as_tibble()
```

# Most invasive species by Family

One important consideration in invasion science is the fact that closely-related species are known to share biological, behavioural and ecological characteristics. Because of this, when a species becomes invasive it is a good rule-of-thumb to treat closely-related species with extreme caution. So let's first have a look at which herpetofaunal families have already demonstrated invasive potential, how many species in each family have already established populations outside their natural range, and how many total unique invasions each family is repsonsible for.

```{r herp invasion}

sp_fam <- a_range_tbl %>% 
          group_by(Family) %>% 
          tally(n_distinct(Species), name = "Total_species")     #Counts the number of species in each Family 

inv_family <- a_range_tbl %>% 
              group_by (Family) %>% 
              count(name = "Total_invasions") %>%                #creates a column called "Total_invasions" for the counts
              inner_join(sp_fam, by = "Family") %>% 
              arrange(desc(Total_invasions))
              
invfam_plot <-  ggplot(inv_family) + 
                geom_col(mapping = aes(x = Family, 
                                       y = Total_invasions,
                                       fill = factor(Family),
                                       text = paste('Family:', Family,
                                                    '<br> Total Unique Invasions:', Total_invasions))) +
                ylab("Total number of Unique Invasions") +
                theme(legend.position = "none",
                      axis.text.x = element_text(angle = 90, hjust = 1))
                
ggplotly(invfam_plot, 
          tooltip = "text"
          )
```

# Number of alien range countries for each species

# Issues I encountered
Family names in the GISD database appear to be out of date for some families. I'm not sure how often the database gets updated with taxonomic information. Contact the administrator?


# Inferred date of establishment?

# Appendix

I made an animated version of the Total Unique Invasions bar chart to post to my Twitter account on 25 Feb 2020. This is the code for generating the animated version with the Family names removed from the X-axis. The biggest difference is that you need to add a variable that specifies the states of the chart during animation. In this case I added a variable called "Frame" with two states - 0 invasions or all invasions. I had to create a dataframe with zero invasions for all families and then join them together for the plot. 

```{r animated plot}

a <- data.frame(Family = c(inv_family$Family), Total_invasions = rep(0,18), frame = rep('a',18))
b <- data.frame(Family = c(inv_family$Family), Total_invasions = c(inv_family$Total_invasions), frame = rep('b',18))
invfa_anim_df <- rbind(a,b); rm(a,b)

invfam_anim <- ggplot(invfa_anim_df, aes(x = Family, y = Total_invasions, fill = Family)) +
                geom_bar(stat = 'identity') + 
                ylab("Total number of Unique Invasions") +
                scale_x_discrete(labels= c(rep("?",18))) +
                theme(legend.position = "none") +
                transition_states(
                    frame,
                    transition_length = 2,
                    state_length = 1,
                    wrap = TRUE
                )

print(invfam_anim) 

#anim_save("unique_invasions_by_family.gif", animation = invfam_anim)
```






